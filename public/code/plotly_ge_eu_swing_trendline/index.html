<html>
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta http-equiv="X-UA-Compatible" content="ie=edge">
     <link rel="stylesheet" href="/css/syntax.css"/>
     <title>Document</title>
</head>
<body>
    <div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#a90d91">import</span> <span style="color:#000">pandas</span> <span style="color:#a90d91">as</span> <span style="color:#000">pd</span>
<span style="color:#a90d91">import</span> <span style="color:#000">plotly</span><span style="color:#000">.</span><span style="color:#000">express</span> <span style="color:#a90d91">as</span> <span style="color:#000">px</span>

<span style="color:#000">colour_dict</span> <span style="color:#000">=</span> <span style="color:#a90d91">dict</span>({<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">CON HOLD</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">blue</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">CON GAIN</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">aqua</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LAB HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">red</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LAB GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">violet</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">GRN HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">green</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">DUP HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">sandybrown</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LD HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">yellow</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LD GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">orange</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SNP HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">black</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SNP GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">gray</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">PC HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">pink</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SF HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">peru</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SF GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">wheat</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SDLP HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">salmon</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SDLP GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">lightsalmon</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">APNI GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">lawngreen</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SPE HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">navy</span><span style="color:#c41a16">&#39;</span>})

<span style="color:#000">df_con</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">constituencies.csv</span><span style="color:#c41a16">&#39;</span>)
<span style="color:#000">df_can_res</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">candidate_results.csv</span><span style="color:#c41a16">&#39;</span>)
<span style="color:#000">df_con_head</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">constituency_headline.csv</span><span style="color:#c41a16">&#39;</span>)
<span style="color:#000">df_con_eu</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">eureferendum_constituency.csv</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#000">age_start</span> <span style="color:#000">=</span> <span style="color:#1c01ce">18</span>
<span style="color:#000">winning_party_list</span> <span style="color:#000">=</span> [<span style="color:#c41a16"></span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">LAB</span><span style="color:#c41a16">&#34;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">CON</span><span style="color:#c41a16">&#34;</span>]

<span style="color:#177500"># TO DO: Select only required columns in joins, maybe need merge for this</span>

<span style="color:#177500"># add ons code to candidate results</span>
<span style="color:#000">df_res</span> <span style="color:#000">=</span> <span style="color:#000">df_con</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">df_can_res</span><span style="color:#000">.</span><span style="color:#000">set_index</span>([<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">conID</span><span style="color:#c41a16">&#39;</span>]), <span style="color:#000">on</span><span style="color:#000">=</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">conID</span><span style="color:#c41a16">&#39;</span>], <span style="color:#000">how</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">inner</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># include only the two parties with the most votes in each seat</span>
<span style="color:#000">df_res</span> <span style="color:#000">=</span> <span style="color:#000">df_res</span><span style="color:#000">.</span><span style="color:#000">sort_values</span>([<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">votes</span><span style="color:#c41a16">&#39;</span>])<span style="color:#000">.</span><span style="color:#000">groupby</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>)<span style="color:#000">.</span><span style="color:#000">tail</span>(<span style="color:#1c01ce">2</span>)

<span style="color:#177500"># exclude parties other than lab and con</span>
<span style="color:#000">df_res</span> <span style="color:#000">=</span> <span style="color:#000">df_res</span>[<span style="color:#000">df_res</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">partyCode</span><span style="color:#c41a16">&#39;</span>]<span style="color:#000">.</span><span style="color:#000">isin</span>(<span style="color:#000">winning_party_list</span>)]

<span style="color:#177500"># exclude seats with only one row</span>
<span style="color:#000">df_res</span> <span style="color:#000">=</span> <span style="color:#000">df_res</span><span style="color:#000">.</span><span style="color:#000">groupby</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>)<span style="color:#000">.</span><span style="color:#000">filter</span>(<span style="color:#a90d91">lambda</span> <span style="color:#000">x</span>: <span style="color:#a90d91">len</span>(<span style="color:#000">x</span>) <span style="color:#000">&gt;</span> <span style="color:#1c01ce">1</span>)

<span style="color:#177500"># we want the vote share for both Lab and Con</span>
<span style="color:#177500"># get df for Lab vote share change</span>
<span style="color:#000">query_string</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">partyCode ==</span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">LAB</span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">&#39;</span>
<span style="color:#000">df_lvsc</span> <span style="color:#000">=</span> <span style="color:#000">df_res</span><span style="color:#000">.</span><span style="color:#000">query</span>(<span style="color:#000">query_string</span>)

<span style="color:#177500"># rename vote share change column</span>
<span style="color:#000">df_lvsc</span><span style="color:#000">.</span><span style="color:#000">rename</span>(<span style="color:#000">columns</span><span style="color:#000">=</span> {<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">voteShareChange</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">lvsc</span><span style="color:#c41a16">&#39;</span>}, <span style="color:#000">inplace</span><span style="color:#000">=</span><span style="color:#a90d91">True</span>)

<span style="color:#177500"># get df for Con vote share change</span>
<span style="color:#000">query_string</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">partyCode ==</span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">CON</span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">&#39;</span>
<span style="color:#000">df_cvsc</span> <span style="color:#000">=</span> <span style="color:#000">df_res</span><span style="color:#000">.</span><span style="color:#000">query</span>(<span style="color:#000">query_string</span>)

<span style="color:#177500"># rename vote share change column</span>
<span style="color:#000">df_cvsc</span><span style="color:#000">.</span><span style="color:#000">rename</span>(<span style="color:#000">columns</span><span style="color:#000">=</span> {<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">voteShareChange</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">cvsc</span><span style="color:#c41a16">&#39;</span>}, <span style="color:#000">inplace</span><span style="color:#000">=</span><span style="color:#a90d91">True</span>)

<span style="color:#177500"># now join the two into one df</span>

<span style="color:#000">df_swing</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">merge</span>(<span style="color:#000">df_lvsc</span>,<span style="color:#000">df_cvsc</span>[[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>,<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">cvsc</span><span style="color:#c41a16">&#39;</span>]],<span style="color:#000">on</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">how</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">left</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># now calculate the swing to the cons using the Butler method: (cvsc - lvsc) / 2</span>
<span style="color:#000">df_swing</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">swing</span><span style="color:#c41a16">&#39;</span>] <span style="color:#000">=</span> (<span style="color:#000">df_swing</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">cvsc</span><span style="color:#c41a16">&#39;</span>] <span style="color:#000">-</span> <span style="color:#000">df_swing</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">lvsc</span><span style="color:#c41a16">&#39;</span>]) <span style="color:#000">/</span> <span style="color:#1c01ce">2</span>

<span style="color:#177500"># join EU data with election headlines</span>
<span style="color:#000">df_eu_hd</span> <span style="color:#000">=</span> <span style="color:#000">df_con_eu</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">df_con_head</span><span style="color:#000">.</span><span style="color:#000">set_index</span>([<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>]), <span style="color:#000">on</span><span style="color:#000">=</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons_code</span><span style="color:#c41a16">&#39;</span>], <span style="color:#000">how</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">inner</span><span style="color:#c41a16">&#39;</span>)
<span style="color:#177500">#print(&#39;df_eu_hd&#39;)</span>
<span style="color:#177500">#print(sorted(df_eu_hd))</span>

<span style="color:#177500"># join with the vote share change data for selected party.</span>
<span style="color:#000">df_eu_vs</span> <span style="color:#000">=</span> <span style="color:#000">df_eu_hd</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">df_swing</span><span style="color:#000">.</span><span style="color:#000">set_index</span>([<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>]), <span style="color:#000">on</span><span style="color:#000">=</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons_code</span><span style="color:#c41a16">&#39;</span>], <span style="color:#000">how</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">inner</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># remove % sign and convert to float</span>
<span style="color:#000">df_eu_vs</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">leave_to_use</span><span style="color:#c41a16">&#39;</span>] <span style="color:#000">=</span> <span style="color:#000">df_eu_vs</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">leave_to_use</span><span style="color:#c41a16">&#39;</span>]<span style="color:#000">.</span><span style="color:#000">str</span><span style="color:#000">.</span><span style="color:#000">rstrip</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">%</span><span style="color:#c41a16">&#39;</span>)<span style="color:#000">.</span><span style="color:#000">astype</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">float</span><span style="color:#c41a16">&#39;</span>) 

<span style="color:#177500"># replace WIN with HOLD (not clear how it differs)</span>
<span style="color:#000">df_eu_vs</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">headline</span><span style="color:#c41a16">&#39;</span>] <span style="color:#000">=</span> <span style="color:#000">df_eu_vs</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">flash</span><span style="color:#c41a16">&#39;</span>]<span style="color:#000">.</span><span style="color:#000">apply</span>(<span style="color:#a90d91">lambda</span> <span style="color:#000">x</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16"> </span><span style="color:#c41a16">&#39;</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">x</span><span style="color:#000">.</span><span style="color:#000">split</span>()[:<span style="color:#1c01ce">2</span>]))<span style="color:#000">.</span><span style="color:#000">str</span><span style="color:#000">.</span><span style="color:#000">replace</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">WIN</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">HOLD</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500">#df_age_eu_vs.rename(columns = {&#39;conName&#39;:&#39;Constituency&#39;}, inplace = True) </span>
<span style="color:#000">df_eu_vs</span><span style="color:#000">.</span><span style="color:#000">rename</span>(<span style="color:#000">columns</span> <span style="color:#000">=</span> {<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">wpp</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Last election</span><span style="color:#c41a16">&#39;</span>}, <span style="color:#000">inplace</span> <span style="color:#000">=</span> <span style="color:#a90d91">True</span>) 

<span style="color:#000">fig</span> <span style="color:#000">=</span> <span style="color:#000">px</span><span style="color:#000">.</span><span style="color:#000">scatter</span>(<span style="color:#000">df_eu_vs</span>, <span style="color:#000">x</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">leave_to_use</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">y</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">swing</span><span style="color:#c41a16">&#39;</span>,
              <span style="color:#000">color</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">headline</span><span style="color:#c41a16">&#39;</span>,<span style="color:#000">hover_name</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">conName</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">hover_data</span> <span style="color:#000">=</span> [<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Last election</span><span style="color:#c41a16">&#39;</span>], 
              <span style="color:#000">labels</span> <span style="color:#000">=</span> {<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">leave_to_use</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Leave </span><span style="color:#c41a16">%</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">swing</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Swing from Labour to Conservative </span><span style="color:#c41a16">%</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">headline</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Result</span><span style="color:#c41a16">&#39;</span>}, 
              <span style="color:#000">title</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Constituency leave vote by swing from Labour to Conservative</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">color_discrete_map</span> <span style="color:#000">=</span> <span style="color:#000">colour_dict</span>, <span style="color:#000">trendline</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ols</span><span style="color:#c41a16">&#39;</span>)               

<span style="color:#000">fig</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">layout</span><span style="color:#c41a16">&#39;</span>]<span style="color:#000">.</span><span style="color:#000">update</span>(<span style="color:#000">scene</span><span style="color:#000">=</span><span style="color:#a90d91">dict</span>(<span style="color:#000">aspectmode</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">data</span><span style="color:#c41a16">&#34;</span>))

<span style="color:#000">fig</span><span style="color:#000">.</span><span style="color:#000">show</span>()  

<span style="color:#a90d91">with</span> <span style="color:#a90d91">open</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">plotly_ge_eu_swing_trendline.html</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">w</span><span style="color:#c41a16">&#39;</span>) <span style="color:#a90d91">as</span> <span style="color:#000">f</span>:
   <span style="color:#000">f</span><span style="color:#000">.</span><span style="color:#000">write</span>(<span style="color:#000">fig</span><span style="color:#000">.</span><span style="color:#000">to_html</span>(<span style="color:#000">include_plotlyjs</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">cdn</span><span style="color:#c41a16">&#39;</span>))


</code></pre></td></tr></table>
</div>
</div>
</body>
</html>