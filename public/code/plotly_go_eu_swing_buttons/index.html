<html>
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta http-equiv="X-UA-Compatible" content="ie=edge">
     <link rel="stylesheet" href="/css/syntax.css"/>
     <title>Document</title>
</head>
<body>
    <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-py3" data-lang="py3"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly</span><span class="nn">.</span><span class="nn">graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">exit</span>

<span class="n">colour_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">CON HOLD</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">blue</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">CON GAIN</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">aqua</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LAB HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">red</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LAB GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">violet</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">GRN HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">green</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">DUP HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">sandybrown</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LD HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">yellow</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LD GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">orange</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SNP HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">black</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SNP GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">gray</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">PC HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">pink</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SF HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">peru</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SF GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">wheat</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SDLP HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">salmon</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SDLP GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">lightsalmon</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">APNI GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">lawngreen</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SPE HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">navy</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">)</span>

<span class="n">df_con</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">constituencies.csv</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_can_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">candidate_results.csv</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_con_head</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">constituency_headline.csv</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_con_eu</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">eureferendum_constituency.csv</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">HoC-2019GE-results-by-constituency.csv</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">age_start</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">winning_party_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">LAB</span><span class="s2">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">CON</span><span class="s2">&#34;</span><span class="p">]</span>

<span class="c1"># add ons code to candidate results</span>
<span class="n">df_res</span> <span class="o">=</span> <span class="n">df_con</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_can_res</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">conID</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">conID</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">inner</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># include only the two parties with the most votes in each seat</span>
<span class="n">df_res</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">votes</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># exclude parties other than lab and con</span>
<span class="n">df_res</span> <span class="o">=</span> <span class="n">df_res</span><span class="p">[</span><span class="n">df_res</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">partyCode</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">winning_party_list</span><span class="p">)</span><span class="p">]</span>

<span class="c1"># exclude seats with only one row</span>
<span class="n">df_res</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># we want the vote share for both Lab and Con</span>
<span class="c1"># get df for Lab vote share change</span>
<span class="n">query_string</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">partyCode ==</span><span class="s1">&#34;</span><span class="s1">LAB</span><span class="s1">&#34;</span><span class="s1">&#39;</span>
<span class="n">df_lvsc</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>

<span class="c1"># rename vote share change column</span>
<span class="n">df_lvsc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span> <span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">voteShareChange</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">lvsc</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># get df for Con vote share change</span>
<span class="n">query_string</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">partyCode ==</span><span class="s1">&#34;</span><span class="s1">CON</span><span class="s1">&#34;</span><span class="s1">&#39;</span>
<span class="n">df_cvsc</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>

<span class="c1"># rename vote share change column</span>
<span class="n">df_cvsc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span> <span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">voteShareChange</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">cvsc</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># now join the two into one df</span>

<span class="n">df_swing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_lvsc</span><span class="p">,</span><span class="n">df_cvsc</span><span class="p">[</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">cvsc</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">]</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">left</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># now calculate the swing to the cons using the Butler method: (cvsc - lvsc) / 2</span>
<span class="n">df_swing</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">swing</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_swing</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">cvsc</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_swing</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">lvsc</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># join EU data with election headlines</span>
<span class="n">df_eu_hd</span> <span class="o">=</span> <span class="n">df_con_eu</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_con_head</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons_code</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">inner</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#print(&#39;df_eu_hd&#39;)</span>
<span class="c1">#print(sorted(df_eu_hd))</span>

<span class="c1"># join the result with age data</span>
<span class="c1">#df_eu_vs = df_age_grp.join(df_eu_hd.set_index([&#39;ons_code&#39;]), on=[&#39;PCON11CD&#39;], how=&#39;inner&#39;)</span>

<span class="c1"># join with the vote share change data for selected party.</span>
<span class="n">df_eu_vs</span> <span class="o">=</span> <span class="n">df_eu_hd</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_swing</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons_code</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">inner</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># remove % sign and convert to float</span>
<span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">%</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">float</span><span class="s1">&#39;</span><span class="p">)</span> 

<span class="c1"># replace WIN with HOLD (not clear how it differs)</span>
<span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">headline</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">flash</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1"> </span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="p">)</span><span class="p">[</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="p">)</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">WIN</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">HOLD</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># round percentages</span>
<span class="n">decimals</span> <span class="o">=</span> <span class="mi">1</span>    
<span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">decimals</span><span class="p">)</span><span class="p">)</span>

<span class="n">df_eu_vs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">constituency_name</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Constituency</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">headline</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LAB HOLD</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">red</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">headline</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LAB GAIN</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">violet</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">headline</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">CON HOLD</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">blue</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">aqua</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">col</span>    

<span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">colour</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">df_eu_vs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_color</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># variables for colorscale</span>
<span class="n">color_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">CON GAIN</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">CON HOLD</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">LAB GAIN</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">LAB HOLD</span><span class="s1">&#39;</span><span class="p">]</span>
<span class="n">color_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">color_names</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
<span class="n">num_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_vals</span><span class="p">)</span>

<span class="c1"># map the interval [0, max_val] to [0,1] by t--&gt; t/max_val</span>
<span class="c1"># see https://community.plot.ly/t/manually-customize-colorbar-scatter-python/18520</span>
<span class="c1"># and https://community.plot.ly/t/colors-for-discrete-ranges-in-heatmaps/7780</span>

<span class="c1"># displayed with highest number at top</span>
<span class="n">colorscale</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">aqua</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
    <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">aqua</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
    <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">blue</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
    <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">blue</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
    <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">violet</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">violet</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
    <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">red</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">red</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">]</span>
<span class="n">cmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">cmax</span> <span class="o">=</span> <span class="n">num_colors</span> <span class="o">-</span> <span class="mf">0.5</span>

<span class="c1"># ONS regions</span>
<span class="sa"></span><span class="s2">&#34;&#34;&#34;</span><span class="s2"></span><span class="s2">
</span><span class="s2"></span><span class="s2">ons_region_id	region_name	CountOfons_id</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000001	North East	29</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000002	North West	75</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000003	Yorkshire and The Humber	54</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000004	East Midlands	46</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000005	West Midlands	59</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000006	East	58</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000007	London	73</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000008	South East	84</span><span class="s2">
</span><span class="s2"></span><span class="s2">E12000009	South West	55</span><span class="s2">
</span><span class="s2"></span><span class="s2">N92000002	Northern Ireland	18</span><span class="s2">
</span><span class="s2"></span><span class="s2">S92000003	Scotland	59</span><span class="s2">
</span><span class="s2"></span><span class="s2">W92000004	Wales	40</span><span class="s2">
</span><span class="s2"></span><span class="s2">&#34;&#34;&#34;</span>

<span class="c1"># join with regions data</span>
<span class="n">df_eu_vs</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_regions</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons_id</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons_code</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">inner</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># print(list(df_eu_vs.columns))</span>
<span class="c1"># exit(0)</span>

<span class="c1"># Initialize figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="p">)</span>

<span class="c1"># html for hover text</span>
<span class="n">hvt</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">&lt;b&gt;</span><span class="s1">%</span><span class="si">{text}</span><span class="s1">&lt;/b&gt;&lt;br&gt;&lt;b&gt;Mean age&lt;/b&gt;: </span><span class="s1">%</span><span class="si">{x}</span><span class="s1">&lt;br&gt;&lt;b&gt;Leave vote&lt;/b&gt;: </span><span class="s1">%</span><span class="si">{y:.3n}</span><span class="s1">%</span><span class="s1">&lt;br&gt;&lt;b&gt;Last election&lt;/b&gt;: </span><span class="s1">%</span><span class="si">{customdata}</span><span class="s1">&lt;extra&gt;</span><span class="s1">%</span><span class="s1">&lt;/extra&gt;</span><span class="s1">&#39;</span>

<span class="c1"># variables for button position</span>
<span class="n">button_layer_1_height</span> <span class="o">=</span> <span class="mf">1.12</span>
<span class="n">button_layer_2_height</span> <span class="o">=</span> <span class="mf">1.065</span>

<span class="c1"># list of buttons</span>
<span class="n">btnlist</span> <span class="o">=</span> <span class="p">[</span><span class="p">]</span>
<span class="n">i</span><span class="o">=</span><span class="mi">0</span>

<span class="c1"># list of booleans specifying which trace is visible</span>
<span class="n">vislist</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span>

<span class="c1"># make trace for all regions visible initially</span>
<span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>    

<span class="c1"># first add trace for all regions</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> 
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">swing</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">markers</span><span class="s1">&#39;</span><span class="p">,</span> 
        <span class="n">marker</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Result</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">tickvals</span><span class="o">=</span> <span class="n">color_vals</span><span class="p">,</span>
                <span class="n">ticktext</span><span class="o">=</span> <span class="n">color_names</span><span class="p">,</span>
                <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="p">,</span>
                <span class="nb">len</span><span class="o">=</span><span class="mf">0.2</span>
            <span class="p">)</span><span class="p">,</span>
            <span class="n">colorscale</span> <span class="o">=</span> <span class="n">colorscale</span><span class="p">,</span>
            <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span>
            <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">,</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">colour</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="p">,</span> 
        <span class="n">text</span><span class="o">=</span><span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Constituency</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> 
        <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hvt</span><span class="p">,</span> 
        <span class="n">customdata</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">wpp</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># add new button to list</span>
<span class="n">btnlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="p">{</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">visible</span><span class="s2">&#34;</span><span class="p">:</span> <span class="n">vislist</span><span class="p">}</span><span class="p">]</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">All</span><span class="s2">&#34;</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">update</span><span class="s2">&#34;</span>
        <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># create buttons in list (only one so far)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">updatemenus</span><span class="o">=</span><span class="p">[</span>
        <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Updatemenu</span><span class="p">(</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">buttons</span><span class="s2">&#34;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">right</span><span class="s2">&#34;</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="p">{</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">r</span><span class="s2">&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">t</span><span class="s2">&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span><span class="p">,</span>
            <span class="n">showactive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">xanchor</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">left</span><span class="s2">&#34;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">button_layer_2_height</span><span class="p">,</span>
            <span class="n">yanchor</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">top</span><span class="s2">&#34;</span><span class="p">,</span>
            <span class="n">buttons</span><span class="o">=</span><span class="n">btnlist</span><span class="p">,</span>                    
        <span class="p">)</span><span class="p">,</span>          
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">i</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># get list of regions sorted by ons region id</span>
<span class="n">regions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_eu_vs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons_region_id</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">region_name</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>

<span class="c1"># Create a data frame dictionary for regional dfs</span>
<span class="n">regiondict</span> <span class="o">=</span> <span class="p">{</span><span class="n">region</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="p">)</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">}</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">regiondict</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
    <span class="n">regiondict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_eu_vs</span><span class="p">[</span><span class="p">:</span><span class="p">]</span><span class="p">[</span><span class="n">df_eu_vs</span><span class="o">.</span><span class="n">region_name</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>

<span class="c1"># Add Traces and buttons for each region</span>
<span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">regiondict</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> 
            <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">swing</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">markers</span><span class="s1">&#39;</span><span class="p">,</span> 
            <span class="n">marker</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">colorbar</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Result</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">tickvals</span><span class="o">=</span> <span class="n">color_vals</span><span class="p">,</span>
                <span class="n">ticktext</span><span class="o">=</span> <span class="n">color_names</span><span class="p">,</span>
                <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="p">,</span>
                <span class="nb">len</span><span class="o">=</span><span class="mf">0.2</span>
            <span class="p">)</span><span class="p">,</span>
            <span class="n">colorscale</span> <span class="o">=</span> <span class="n">colorscale</span><span class="p">,</span>
            <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span>
            <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">,</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">colour</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="p">,</span> 
            <span class="n">text</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Constituency</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> 
            <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hvt</span><span class="p">,</span> 
            <span class="n">customdata</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">wpp</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># re-initialise for this button</span>
    <span class="n">vislist</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">12</span>
    <span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>    

    <span class="c1"># add new button to list</span>
    <span class="n">btnlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="p">{</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">visible</span><span class="s2">&#34;</span><span class="p">:</span> <span class="n">vislist</span><span class="p">}</span><span class="p">]</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">update</span><span class="s2">&#34;</span>
            <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># for each iteration we recreate all the buttons. Not ideal but there </span>
    <span class="c1"># doesn&#39;t seem to be any alternative apart from hard coding the region </span>
    <span class="c1"># names and creating the buttons individually without looping.</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">updatemenus</span><span class="o">=</span><span class="p">[</span>
            <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Updatemenu</span><span class="p">(</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">buttons</span><span class="s2">&#34;</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">right</span><span class="s2">&#34;</span><span class="p">,</span>
                <span class="n">pad</span><span class="o">=</span><span class="p">{</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">r</span><span class="s2">&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">t</span><span class="s2">&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span><span class="p">,</span>
                <span class="n">showactive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">left</span><span class="s2">&#34;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">button_layer_2_height</span><span class="p">,</span>
                <span class="n">yanchor</span><span class="o">=</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">top</span><span class="s2">&#34;</span><span class="p">,</span>
                <span class="n">buttons</span><span class="o">=</span><span class="n">btnlist</span><span class="p">,</span> 
                <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>                   
            <span class="p">)</span><span class="p">,</span>          
        <span class="p">]</span>
    <span class="p">)</span>  

    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  

<span class="c1"># common to all traces    </span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">&lt;b&gt;Constituency leave vote by swing from Labour to Conservative&lt;/b&gt;</span><span class="s1">&#39;</span><span class="p">,</span> 
    <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">xaxis</span><span class="o">=</span><span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">title</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Leave </span><span class="s1">%</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">,</span> 
    <span class="n">yaxis</span><span class="o">=</span><span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">title</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Swing from Labour to Conservative </span><span class="s1">%</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">,</span><span class="p">)</span>

<span class="c1"># add extra explanatory text</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">annotations</span><span class="o">=</span><span class="p">[</span>
        <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Annotation</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Seats won by&lt;br&gt;Conservative&lt;br&gt;or Labour</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">align</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">left</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">xref</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">paper</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">yref</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">paper</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="c1"># bordercolor=&#39;black&#39;,</span>
            <span class="c1"># borderwidth=1,</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">plotly_go_eu_swing_buttons.html</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">w</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">include_plotlyjs</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">cdn</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">)</span>

</code></pre></td></tr></table>
</div>
</div>
</body>
</html>