<html>
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta http-equiv="X-UA-Compatible" content="ie=edge">
     <link rel="stylesheet" href="/css/syntax.css"/>
     <title>Document</title>
</head>
<body>
    <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-py3" data-lang="py3"><span class="kn">import</span> <span class="nn">matplotlib</span><span class="nn">.</span><span class="nn">pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly</span><span class="nn">.</span><span class="nn">express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="n">colour_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">CON HOLD</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">blue</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">CON GAIN</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">aqua</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LAB HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">red</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LAB GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">violet</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">GRN HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">green</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">DUP HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">sandybrown</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LD HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">yellow</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">LD GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">orange</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SNP HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">black</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SNP GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">gray</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">PC HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">pink</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SF HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">peru</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SF GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">wheat</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SDLP HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">salmon</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SDLP GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">lightsalmon</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">APNI GAIN</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">lawngreen</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="sa"></span><span class="s1">&#39;</span><span class="s1">SPE HOLD</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">navy</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">)</span>

<span class="n">df_age</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Age_by_year_data.csv</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_con_head</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">constituency_headline.csv</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df_con_eu</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">eureferendum_constituency.csv</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">age_start</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">winning_party_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">LAB</span><span class="s2">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">CON</span><span class="s2">&#34;</span><span class="p">]</span>

<span class="c1"># filter on party if required. Comment out to show all parties. If filtering, adjust legend order list accordingly.</span>
<span class="c1"># This filter is for the result represented by the dots and can be for multiple parties.</span>
<span class="n">df_con_head</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">wp in @winning_party_list</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># first get required age range</span>
<span class="n">df_age</span> <span class="o">=</span> <span class="n">df_age</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">Age_year &gt;= </span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">age_start</span><span class="p">)</span><span class="p">)</span>

<span class="c1"># group by constituency and calculate mean ages</span>
<span class="n">df_age_grp</span> <span class="o">=</span> <span class="n">df_age</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">PCON11CD</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="p">)</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Age_year</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Age_pop</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># convert series to dataframe with same name</span>
<span class="n">df_age_grp</span> <span class="o">=</span> <span class="n">df_age_grp</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="p">)</span>

<span class="c1"># give column a name</span>
<span class="n">df_age_grp</span> <span class="o">=</span> <span class="n">df_age_grp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">mean_age</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">)</span>

<span class="c1"># join EU data with election headlines</span>
<span class="n">df_eu_hd</span> <span class="o">=</span> <span class="n">df_con_eu</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_con_head</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons_code</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">inner</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># join the result with age data</span>
<span class="n">df_age_eu</span> <span class="o">=</span> <span class="n">df_age_grp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_eu_hd</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">ons_code</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">PCON11CD</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">inner</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># replace WIN with HOLD (not clear how it differs)</span>
<span class="n">df_age_eu</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">headline</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_age_eu</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">flash</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1"> </span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="p">)</span><span class="p">[</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="p">)</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">WIN</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">HOLD</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># remove % sign and convert to float</span>
<span class="n">df_age_eu</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_age_eu</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">%</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">float</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span>

<span class="c1"># round decimals</span>
<span class="n">decimals</span> <span class="o">=</span> <span class="mi">1</span>    
<span class="n">df_age_eu</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_age_eu</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">decimals</span><span class="p">)</span><span class="p">)</span>
<span class="n">df_age_eu</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">mean_age</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_age_eu</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">mean_age</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">decimals</span><span class="p">)</span><span class="p">)</span>

<span class="n">df_age_eu</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">constituency_name</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Constituency</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
<span class="n">df_age_eu</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">wpp</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Last election</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_age_eu</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">mean_age</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">color</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">headline</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">hover_name</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Constituency</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">hover_data</span> <span class="o">=</span> <span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Last election</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>
              <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">mean_age</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Mean age of electorate</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">leave_to_use</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Leave </span><span class="s1">%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">headline</span><span class="s1">&#39;</span><span class="p">:</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Result</span><span class="s1">&#39;</span><span class="p">}</span><span class="p">,</span> 
              <span class="n">title</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Mean age of electorate by constituency leave vote</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color_discrete_map</span> <span class="o">=</span> <span class="n">colour_dict</span><span class="p">)</span> 
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">plotly_ge_meanage_eu_lc</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">w</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">include_plotlyjs</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">cdn</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
</body>
</html>