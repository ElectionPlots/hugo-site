<html>
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta http-equiv="X-UA-Compatible" content="ie=edge">
     <link rel="stylesheet" href="/css/style.css"/>
     
     <title>Document</title>
</head>
<body>
    <div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">96
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#a90d91">import</span> <span style="color:#000">pandas</span> <span style="color:#a90d91">as</span> <span style="color:#000">pd</span>
<span style="color:#a90d91">import</span> <span style="color:#000">plotly</span><span style="color:#000">.</span><span style="color:#000">express</span> <span style="color:#a90d91">as</span> <span style="color:#000">px</span>

<span style="color:#000">color_dict</span> <span style="color:#000">=</span> <span style="color:#a90d91">dict</span>({<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">CON HOLD</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">blue</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">CON GAIN</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">aqua</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LAB HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">red</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LAB GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">violet</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">GRN HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">green</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">DUP HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">sandybrown</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LD HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">yellow</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LD GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">orange</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SNP HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">black</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SNP GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">gray</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">PC HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">pink</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SF HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">peru</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SF GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">wheat</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SDLP HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">salmon</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SDLP GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">lightsalmon</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">APNI GAIN</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">lawngreen</span><span style="color:#c41a16">&#39;</span>,
                  <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">SPE HOLD</span><span style="color:#c41a16">&#39;</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">navy</span><span style="color:#c41a16">&#39;</span>})

<span style="color:#000">df_con</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">constituencies.csv</span><span style="color:#c41a16">&#39;</span>)
<span style="color:#000">df_can_res</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">candidate_results.csv</span><span style="color:#c41a16">&#39;</span>)
<span style="color:#000">df_age</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Age_by_year_data.csv</span><span style="color:#c41a16">&#39;</span>)
<span style="color:#000">df_con_head</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">constituency_headline.csv</span><span style="color:#c41a16">&#39;</span>)
<span style="color:#000">df_con_eu</span> <span style="color:#000">=</span> <span style="color:#000">pd</span><span style="color:#000">.</span><span style="color:#000">read_csv</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">eureferendum_constituency.csv</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#000">age_start</span> <span style="color:#000">=</span> <span style="color:#1c01ce">18</span>
<span style="color:#000">party_vsc</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">LAB</span><span style="color:#c41a16">&#39;</span>
<span style="color:#000">winning_party_list</span> <span style="color:#000">=</span> [<span style="color:#c41a16"></span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">LAB</span><span style="color:#c41a16">&#34;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">CON</span><span style="color:#c41a16">&#34;</span>]

<span style="color:#177500"># filter candidate results by party. We only want the vote share for one party. This is for the vote share change axis.</span>
<span style="color:#000">query_string</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">partyCode ==</span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">&#39;</span> <span style="color:#000">+</span> <span style="color:#000">party_vsc</span> <span style="color:#000">+</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">&#39;</span>
<span style="color:#000">df_can_res</span><span style="color:#000">.</span><span style="color:#000">query</span>(<span style="color:#000">query_string</span>, <span style="color:#000">inplace</span> <span style="color:#000">=</span> <span style="color:#a90d91">True</span>)

<span style="color:#177500"># add ons code to candidate results</span>
<span style="color:#000">df_res</span> <span style="color:#000">=</span> <span style="color:#000">df_con</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">df_can_res</span><span style="color:#000">.</span><span style="color:#000">set_index</span>([<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">conID</span><span style="color:#c41a16">&#39;</span>]), <span style="color:#000">on</span><span style="color:#000">=</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">conID</span><span style="color:#c41a16">&#39;</span>], <span style="color:#000">how</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">inner</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># first get required age range</span>
<span style="color:#000">df_age</span> <span style="color:#000">=</span> <span style="color:#000">df_age</span><span style="color:#000">.</span><span style="color:#000">query</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">Age_year &gt;= </span><span style="color:#c41a16">&#34;</span> <span style="color:#000">+</span> <span style="color:#a90d91">str</span>(<span style="color:#000">age_start</span>))

<span style="color:#000">df_age_grp</span> <span style="color:#000">=</span> <span style="color:#000">df_age</span><span style="color:#000">.</span><span style="color:#000">groupby</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#34;</span><span style="color:#c41a16">PCON11CD</span><span style="color:#c41a16">&#34;</span>)<span style="color:#000">.</span><span style="color:#000">apply</span>(<span style="color:#a90d91">lambda</span> <span style="color:#000">df</span>, <span style="color:#000">a</span>, <span style="color:#000">b</span>: <span style="color:#a90d91">sum</span>(<span style="color:#000">df</span>[<span style="color:#000">a</span>] <span style="color:#000">*</span> <span style="color:#000">df</span>[<span style="color:#000">b</span>]) <span style="color:#000">/</span> <span style="color:#a90d91">sum</span>(<span style="color:#000">df</span>[<span style="color:#000">b</span>]), <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Age_year</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Age_pop</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># convert series to dataframe with same name</span>
<span style="color:#000">df_age_grp</span> <span style="color:#000">=</span> <span style="color:#000">df_age_grp</span><span style="color:#000">.</span><span style="color:#000">to_frame</span>()<span style="color:#000">.</span><span style="color:#000">reset_index</span>()

<span style="color:#177500"># give column a name</span>
<span style="color:#000">df_age_grp</span> <span style="color:#000">=</span> <span style="color:#000">df_age_grp</span><span style="color:#000">.</span><span style="color:#000">rename</span>(<span style="color:#000">columns</span><span style="color:#000">=</span> {<span style="color:#1c01ce">0</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">mean_age</span><span style="color:#c41a16">&#39;</span>})


<span style="color:#177500"># filter on party if required. Comment out to show all parties. If filtering, adjust legend order list accordingly.</span>
<span style="color:#177500"># This filter is for the result represented by the dots and can be for multiple parties.</span>
<span style="color:#000">df_con_head</span><span style="color:#000">.</span><span style="color:#000">query</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">wp in @winning_party_list</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">inplace</span> <span style="color:#000">=</span> <span style="color:#a90d91">True</span>)

<span style="color:#177500"># join EU data with election headlines</span>
<span style="color:#000">df_eu_hd</span> <span style="color:#000">=</span> <span style="color:#000">df_con_eu</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">df_con_head</span><span style="color:#000">.</span><span style="color:#000">set_index</span>([<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>]), <span style="color:#000">on</span><span style="color:#000">=</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons_code</span><span style="color:#c41a16">&#39;</span>], <span style="color:#000">how</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">inner</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># join the result with age data</span>
<span style="color:#000">df_age_eu</span> <span style="color:#000">=</span> <span style="color:#000">df_age_grp</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">df_eu_hd</span><span style="color:#000">.</span><span style="color:#000">set_index</span>([<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons_code</span><span style="color:#c41a16">&#39;</span>]), <span style="color:#000">on</span><span style="color:#000">=</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">PCON11CD</span><span style="color:#c41a16">&#39;</span>], <span style="color:#000">how</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">inner</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># join that with the vote share change data for selected party.</span>
<span style="color:#000">df_age_eu_vs</span> <span style="color:#000">=</span> <span style="color:#000">df_age_eu</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">df_res</span><span style="color:#000">.</span><span style="color:#000">set_index</span>([<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">ons</span><span style="color:#c41a16">&#39;</span>]), <span style="color:#000">on</span><span style="color:#000">=</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">PCON11CD</span><span style="color:#c41a16">&#39;</span>], <span style="color:#000">how</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">inner</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># replace WIN with HOLD (not clear how it differs)</span>
<span style="color:#000">df_age_eu_vs</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">headline</span><span style="color:#c41a16">&#39;</span>] <span style="color:#000">=</span> <span style="color:#000">df_age_eu_vs</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">flash</span><span style="color:#c41a16">&#39;</span>]<span style="color:#000">.</span><span style="color:#000">apply</span>(<span style="color:#a90d91">lambda</span> <span style="color:#000">x</span>: <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16"> </span><span style="color:#c41a16">&#39;</span><span style="color:#000">.</span><span style="color:#000">join</span>(<span style="color:#000">x</span><span style="color:#000">.</span><span style="color:#000">split</span>()[:<span style="color:#1c01ce">2</span>]))<span style="color:#000">.</span><span style="color:#000">str</span><span style="color:#000">.</span><span style="color:#000">replace</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">WIN</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">HOLD</span><span style="color:#c41a16">&#39;</span>)

<span style="color:#177500"># round percentages</span>
<span style="color:#000">decimals</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>   
<span style="color:#000">df_age_eu_vs</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">mean_age</span><span style="color:#c41a16">&#39;</span>] <span style="color:#000">=</span> <span style="color:#000">df_age_eu</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">mean_age</span><span style="color:#c41a16">&#39;</span>]<span style="color:#000">.</span><span style="color:#000">apply</span>(<span style="color:#a90d91">lambda</span> <span style="color:#000">x</span>: <span style="color:#a90d91">round</span>(<span style="color:#000">x</span>, <span style="color:#000">decimals</span>))

<span style="color:#177500">#df_age_eu_vs.rename(columns = {&#39;conName&#39;:&#39;Constituency&#39;}, inplace = True) </span>
<span style="color:#000">df_age_eu_vs</span><span style="color:#000">.</span><span style="color:#000">rename</span>(<span style="color:#000">columns</span> <span style="color:#000">=</span> {<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">wpp</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Last election</span><span style="color:#c41a16">&#39;</span>}, <span style="color:#000">inplace</span> <span style="color:#000">=</span> <span style="color:#a90d91">True</span>) 

<span style="color:#177500"># set log_x = &#39;true&#39; to make x axis wider</span>
<span style="color:#000">fig</span> <span style="color:#000">=</span> <span style="color:#000">px</span><span style="color:#000">.</span><span style="color:#000">scatter_3d</span>(<span style="color:#000">df_age_eu_vs</span>, <span style="color:#000">x</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">mean_age</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">y</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">leave_to_use</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">z</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">voteShareChange</span><span style="color:#c41a16">&#39;</span>,
              <span style="color:#000">color</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">headline</span><span style="color:#c41a16">&#39;</span>,<span style="color:#000">hover_name</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">conName</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">hover_data</span> <span style="color:#000">=</span> [<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Last election</span><span style="color:#c41a16">&#39;</span>],
              <span style="color:#000">labels</span> <span style="color:#000">=</span> {<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">mean_age</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Mean age of electorate</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">leave_to_use</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Leave </span><span style="color:#c41a16">%</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">voteShareChange</span><span style="color:#c41a16">&#39;</span>:<span style="color:#000">party_vsc</span> <span style="color:#000">+</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16"> vote share change </span><span style="color:#c41a16">%</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">headline</span><span style="color:#c41a16">&#39;</span>:<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Result</span><span style="color:#c41a16">&#39;</span>}, 
              <span style="color:#000">title</span> <span style="color:#000">=</span> <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">Mean age of electorate by constituency leave vote and change in Labour vote share</span><span style="color:#c41a16">&#39;</span>, <span style="color:#000">color_discrete_map</span> <span style="color:#000">=</span> <span style="color:#000">color_dict</span>, <span style="color:#000">log_x</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">false</span><span style="color:#c41a16">&#39;</span>) 

<span style="color:#000">fig</span>[<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">layout</span><span style="color:#c41a16">&#39;</span>]<span style="color:#000">.</span><span style="color:#000">update</span>(<span style="color:#000">showlegend</span><span style="color:#000">=</span><span style="color:#a90d91">False</span>)

<span style="color:#000">fig</span><span style="color:#000">.</span><span style="color:#000">update_traces</span>(
   <span style="color:#000">marker</span><span style="color:#000">=</span><span style="color:#a90d91">dict</span>(
      <span style="color:#000">size</span><span style="color:#000">=</span><span style="color:#1c01ce">4</span>, <span style="color:#000">line</span> <span style="color:#000">=</span> <span style="color:#a90d91">dict</span>(
                  <span style="color:#000">width</span><span style="color:#000">=</span><span style="color:#1c01ce">2</span>, <span style="color:#000">color</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">DarkSlateGrey</span><span style="color:#c41a16">&#39;</span>
                  )
      ),
   <span style="color:#000">selector</span><span style="color:#000">=</span><span style="color:#a90d91">dict</span>(<span style="color:#000">mode</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">markers</span><span style="color:#c41a16">&#39;</span>)
   )

<span style="color:#000">fig</span><span style="color:#000">.</span><span style="color:#000">show</span>()  

<span style="color:#a90d91">with</span> <span style="color:#a90d91">open</span>(<span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">plotly_ge_meanage_eu_vs.html</span><span style="color:#c41a16">&#39;</span>, <span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">w</span><span style="color:#c41a16">&#39;</span>) <span style="color:#a90d91">as</span> <span style="color:#000">f</span>:
   <span style="color:#000">f</span><span style="color:#000">.</span><span style="color:#000">write</span>(<span style="color:#000">fig</span><span style="color:#000">.</span><span style="color:#000">to_html</span>(<span style="color:#000">include_plotlyjs</span><span style="color:#000">=</span><span style="color:#c41a16"></span><span style="color:#c41a16">&#39;</span><span style="color:#c41a16">cdn</span><span style="color:#c41a16">&#39;</span>))


</code></pre></td></tr></table>
</div>
</div>
    
<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <div id="show_comments"><a id="load_comments" class="button is-link">Load comments</a></div>
  
    <script type="text/javascript">
      var disqus_shortname = 'election-plots';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      
      var hash = window.location.hash.substr(1);
      if ((hash.length > 8) && (hash.substring(0, 8) === "comment-")) {
        disqus();
        document.getElementById("show_comments").style.display = "none";
      } else {
        document.getElementById('load_comments').onclick = function() {
          disqus();
          document.getElementById("show_comments").style.display = "none";
        };
      }
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


</body>
</html>